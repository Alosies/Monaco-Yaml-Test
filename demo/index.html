<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link
      rel="stylesheet"
      data-name="vs/editor/editor.main"
      href="../node_modules/monaco-editor-core/dev/vs/editor/editor.main.css"
    />
  </head>

  <body>
    <h2>Monaco Editor YAML test page</h2>
    <code id="path"></code>
    <div
      id="container"
      style="width:800px;height:600px;border:1px solid grey"
    ></div>

    <style>
      .x-highlight-range {
        background-color: lightblue;
      }
    </style>

    <script>
      // Loading basic-languages to get the YAML language definition
      var paths = {
        'vs/basic-languages': '../node_modules/monaco-languages/release/dev',
        'vs/language/yaml': '../release/dev',
        vs: '../node_modules/monaco-editor-core/dev/vs',
      };
      if (document.location.protocol === 'http:') {
        // Add support for running local http server
        let testIndex = document.location.pathname.indexOf('/test/');
        if (testIndex !== -1) {
          let prefix = document.location.pathname.substr(0, testIndex);
          paths['vs/language/yaml'] = prefix + '/release/dev';
        }
      }
      var require = {
        paths: paths,
      };
    </script>
    <script src="../node_modules/monaco-editor-core/dev/vs/loader.js"></script>
    <script src="../node_modules/monaco-editor-core/dev/vs/editor/editor.main.nls.js"></script>
    <script src="../node_modules/monaco-editor-core/dev/vs/editor/editor.main.js"></script>

    <script>
      let schema = null;
      fetch('https://kubernetesjsonschema.dev/v1.14.0-standalone/pod-v1.json')
        .then(res => res.json())
        .then(resSchema => {
          schema = resSchema;
          console.log(schema);
          require([
            'vs/basic-languages/monaco.contribution',
            'vs/language/yaml/monaco.contribution',
          ], function() {
            const yaml = `apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
    ports:
    - containerPort: 80`;
            const modelUri = monaco.Uri.parse('a://b/foo.json');
            const editor = monaco.editor.create(
              document.getElementById('container'),
              {
                language: 'yaml',
                showFoldingControls: 'always',
                model: monaco.editor.createModel(yaml, 'yaml', modelUri),
              }
            );

            monaco.languages.yaml.yamlDefaults.setDiagnosticsOptions({
              enableSchemaRequest: true,
              validate: true,
              schemas: [
                {
                  fileMatch: ['*.json'],
                  schema,
                },
              ],
            });

            require([
              'vs/editor/contrib/quickOpen/quickOpen',
            ], async quickOpen => {
              const NEVER_CANCEL_TOKEN = {
                isCancellationRequested: false,
                onCancellationRequested: () => Event.NONE,
              };

              let oldDecorations = [];

              async function _getSymbolForPosition(model, position) {
                const symbols = await quickOpen.getDocumentSymbols(
                  model,
                  false,
                  NEVER_CANCEL_TOKEN
                );

                function _recur(symbol) {
                  let target = symbol;
                  if (symbol && symbol.children && symbol.children.length) {
                    target =
                      _recur(
                        symbol.children.find(child =>
                          child.range.containsPosition(position)
                        )
                      ) || symbol;
                  }

                  return target;
                }

                return _recur({ children: symbols });
              }

              editor.onDidChangeCursorSelection(async ({ selection }) => {
                const model = editor.getModel();
                const position = selection.getPosition();
                const symbol = await _getSymbolForPosition(model, position);

                console.log(`${symbol.name}: ${symbol.range}`);
                if (symbol && symbol.range) {
                  const decoration = {
                    range: symbol.range,
                    options: {
                      isWholeLine: false,
                      className: 'x-highlight-range',
                    },
                  };

                  oldDecorations = editor.deltaDecorations(
                    oldDecorations,
                    decoration ? [decoration] : []
                  );
                }
              });
            });
          });
        });
    </script>
  </body>
</html>
